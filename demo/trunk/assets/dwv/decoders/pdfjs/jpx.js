"use strict";var JpxImage=function(){var e={LL:0,LH:1,HL:1,HH:2};function t(){this.failOnCorruptedImage=!0}function r(e,t){e.x0=Math.ceil(t.XOsiz/e.XRsiz),e.x1=Math.ceil(t.Xsiz/e.XRsiz),e.y0=Math.ceil(t.YOsiz/e.YRsiz),e.y1=Math.ceil(t.Ysiz/e.YRsiz),e.width=e.x1-e.x0,e.height=e.y1-e.y0}function i(e,t){for(var r,i=e.SIZ,n=[],a=Math.ceil((i.Xsiz-i.XTOsiz)/i.XTsiz),s=Math.ceil((i.Ysiz-i.YTOsiz)/i.YTsiz),o=0;o<s;o++)for(var c=0;c<a;c++)r={},r.tx0=Math.max(i.XTOsiz+c*i.XTsiz,i.XOsiz),r.ty0=Math.max(i.YTOsiz+o*i.YTsiz,i.YOsiz),r.tx1=Math.min(i.XTOsiz+(c+1)*i.XTsiz,i.Xsiz),r.ty1=Math.min(i.YTOsiz+(o+1)*i.YTsiz,i.Ysiz),r.width=r.tx1-r.tx0,r.height=r.ty1-r.ty0,r.components=[],n.push(r);e.tiles=n;for(var h=i.Csiz,l=0,u=h;l<u;l++)for(var d=t[l],f=0,v=n.length;f<v;f++){var m={};r=n[f],m.tcx0=Math.ceil(r.tx0/d.XRsiz),m.tcy0=Math.ceil(r.ty0/d.YRsiz),m.tcx1=Math.ceil(r.tx1/d.XRsiz),m.tcy1=Math.ceil(r.ty1/d.YRsiz),m.width=m.tcx1-m.tcx0,m.height=m.tcy1-m.tcy0,r.components[l]=m}}function n(e,t,r){var i=t.codingStyleParameters,n={};return i.entropyCoderWithCustomPrecincts?(n.PPx=i.precinctsSizes[r].PPx,n.PPy=i.precinctsSizes[r].PPy):(n.PPx=15,n.PPy=15),n.xcb_=r>0?Math.min(i.xcb,n.PPx-1):Math.min(i.xcb,n.PPx),n.ycb_=r>0?Math.min(i.ycb,n.PPy-1):Math.min(i.ycb,n.PPy),n}function a(e,t,r){var i=1<<r.PPx,n=1<<r.PPy,a=0===t.resLevel,s=1<<r.PPx+(a?0:-1),o=1<<r.PPy+(a?0:-1),c=t.trx1>t.trx0?Math.ceil(t.trx1/i)-Math.floor(t.trx0/i):0,h=t.try1>t.try0?Math.ceil(t.try1/n)-Math.floor(t.try0/n):0,l=c*h;t.precinctParameters={precinctWidth:i,precinctHeight:n,numprecinctswide:c,numprecinctshigh:h,numprecincts:l,precinctWidthInSubband:s,precinctHeightInSubband:o}}function s(e,t,r){var i,n,a,s,o=r.xcb_,c=r.ycb_,h=1<<o,l=1<<c,u=t.tbx0>>o,d=t.tby0>>c,f=t.tbx1+h-1>>o,v=t.tby1+l-1>>c,m=t.resolution.precinctParameters,p=[],b=[];for(n=d;n<v;n++)for(i=u;i<f;i++){a={cbx:i,cby:n,tbx0:h*i,tby0:l*n,tbx1:h*(i+1),tby1:l*(n+1)},a.tbx0_=Math.max(t.tbx0,a.tbx0),a.tby0_=Math.max(t.tby0,a.tby0),a.tbx1_=Math.min(t.tbx1,a.tbx1),a.tby1_=Math.min(t.tby1,a.tby1);var g=Math.floor((a.tbx0_-t.tbx0)/m.precinctWidthInSubband),y=Math.floor((a.tby0_-t.tby0)/m.precinctHeightInSubband);if(s=g+y*m.numprecinctswide,a.precinctNumber=s,a.subbandType=t.type,a.Lblock=3,!(a.tbx1_<=a.tbx0_||a.tby1_<=a.tby0_)){p.push(a);var x=b[s];void 0!==x?(i<x.cbxMin?x.cbxMin=i:i>x.cbxMax&&(x.cbxMax=i),n<x.cbyMin?x.cbxMin=n:n>x.cbyMax&&(x.cbyMax=n)):b[s]=x={cbxMin:i,cbyMin:n,cbxMax:i,cbyMax:n},a.precinct=x}}t.codeblockParameters={codeblockWidth:o,codeblockHeight:c,numcodeblockwide:f-u+1,numcodeblockhigh:v-d+1},t.codeblocks=p,t.precincts=b}function o(e,t,r){for(var i=[],n=e.subbands,a=0,s=n.length;a<s;a++)for(var o=n[a],c=o.codeblocks,h=0,l=c.length;h<l;h++){var u=c[h];u.precinctNumber===t&&i.push(u)}return{layerNumber:r,codeblocks:i}}function c(e){for(var t=e.SIZ,r=e.currentTile.index,i=e.tiles[r],n=i.codingStyleDefaultParameters.layersCount,a=t.Csiz,s=0,c=0;c<a;c++)s=Math.max(s,i.components[c].codingStyleParameters.decompositionLevelsCount);var h=0,l=0,u=0,d=0;this.nextPacket=function(){for(;h<n;h++){for(;l<=s;l++){for(;u<a;u++){var e=i.components[u];if(!(l>e.codingStyleParameters.decompositionLevelsCount)){for(var t=e.resolutions[l],r=t.precinctParameters.numprecincts;d<r;){var c=o(t,d,h);return d++,c}d=0}}u=0}l=0}}}function h(e){for(var t=e.SIZ,r=e.currentTile.index,i=e.tiles[r],n=i.codingStyleDefaultParameters.layersCount,a=t.Csiz,s=0,c=0;c<a;c++)s=Math.max(s,i.components[c].codingStyleParameters.decompositionLevelsCount);var h=0,l=0,u=0,d=0;this.nextPacket=function(){for(;h<=s;h++){for(;l<n;l++){for(;u<a;u++){var e=i.components[u];if(!(h>e.codingStyleParameters.decompositionLevelsCount)){for(var t=e.resolutions[h],r=t.precinctParameters.numprecincts;d<r;){var c=o(t,d,l);return d++,c}d=0}}u=0}l=0}}}function l(e){var t,r,i,n,a=e.SIZ,s=e.currentTile.index,c=e.tiles[s],h=c.codingStyleDefaultParameters.layersCount,l=a.Csiz,u=0;for(i=0;i<l;i++){var d=c.components[i];u=Math.max(u,d.codingStyleParameters.decompositionLevelsCount)}var f=new Int32Array(u+1);for(r=0;r<=u;++r){var v=0;for(i=0;i<l;++i){var m=c.components[i].resolutions;r<m.length&&(v=Math.max(v,m[r].precinctParameters.numprecincts))}f[r]=v}t=0,r=0,i=0,n=0,this.nextPacket=function(){for(;r<=u;r++){for(;n<f[r];n++){for(;i<l;i++){var e=c.components[i];if(!(r>e.codingStyleParameters.decompositionLevelsCount)){var a=e.resolutions[r],s=a.precinctParameters.numprecincts;if(!(n>=s)){for(;t<h;){var d=o(a,n,t);return t++,d}t=0}}}i=0}n=0}}}function u(e){var t=e.SIZ,r=e.currentTile.index,i=e.tiles[r],n=i.codingStyleDefaultParameters.layersCount,a=t.Csiz,s=v(i),c=s,h=0,l=0,u=0,d=0,m=0;this.nextPacket=function(){for(;m<c.maxNumHigh;m++){for(;d<c.maxNumWide;d++){for(;u<a;u++){for(var e=i.components[u],t=e.codingStyleParameters.decompositionLevelsCount;l<=t;l++){var r=e.resolutions[l],v=s.components[u].resolutions[l],p=f(d,m,v,c,r);if(null!==p){for(;h<n;){var b=o(r,p,h);return h++,b}h=0}}l=0}u=0}d=0}}}function d(e){var t=e.SIZ,r=e.currentTile.index,i=e.tiles[r],n=i.codingStyleDefaultParameters.layersCount,a=t.Csiz,s=v(i),c=0,h=0,l=0,u=0,d=0;this.nextPacket=function(){for(;l<a;++l){for(var e=i.components[l],t=s.components[l],r=e.codingStyleParameters.decompositionLevelsCount;d<t.maxNumHigh;d++){for(;u<t.maxNumWide;u++){for(;h<=r;h++){var v=e.resolutions[h],m=t.resolutions[h],p=f(u,d,m,t,v);if(null!==p){for(;c<n;){var b=o(v,p,c);return c++,b}c=0}}h=0}u=0}d=0}}}function f(e,t,r,i,n){var a=e*i.minWidth,s=t*i.minHeight;if(a%r.width!==0||s%r.height!==0)return null;var o=s/r.width*n.precinctParameters.numprecinctswide;return a/r.height+o}function v(e){for(var t=e.components.length,r=Number.MAX_VALUE,i=Number.MAX_VALUE,n=0,a=0,s=new Array(t),o=0;o<t;o++){for(var c=e.components[o],h=c.codingStyleParameters.decompositionLevelsCount,l=new Array(h+1),u=Number.MAX_VALUE,d=Number.MAX_VALUE,f=0,v=0,m=1,p=h;p>=0;--p){var b=c.resolutions[p],g=m*b.precinctParameters.precinctWidth,y=m*b.precinctParameters.precinctHeight;u=Math.min(u,g),d=Math.min(d,y),f=Math.max(f,b.precinctParameters.numprecinctswide),v=Math.max(v,b.precinctParameters.numprecinctshigh),l[p]={width:g,height:y},m<<=1}r=Math.min(r,u),i=Math.min(i,d),n=Math.max(n,f),a=Math.max(a,v),s[o]={resolutions:l,minWidth:u,minHeight:d,maxNumWide:f,maxNumHigh:v}}return{components:s,minWidth:r,minHeight:i,maxNumWide:n,maxNumHigh:a}}function m(e){for(var t=e.SIZ,r=e.currentTile.index,i=e.tiles[r],o=t.Csiz,f=0;f<o;f++){for(var v=i.components[f],m=v.codingStyleParameters.decompositionLevelsCount,p=[],b=[],g=0;g<=m;g++){var y,x=n(e,v,g),P={},w=1<<m-g;if(P.trx0=Math.ceil(v.tcx0/w),P.try0=Math.ceil(v.tcy0/w),P.trx1=Math.ceil(v.tcx1/w),P.try1=Math.ceil(v.tcy1/w),P.resLevel=g,a(e,P,x),p.push(P),0===g)y={},y.type="LL",y.tbx0=Math.ceil(v.tcx0/w),y.tby0=Math.ceil(v.tcy0/w),y.tbx1=Math.ceil(v.tcx1/w),y.tby1=Math.ceil(v.tcy1/w),y.resolution=P,s(e,y,x),b.push(y),P.subbands=[y];else{var C=1<<m-g+1,M=[];y={},y.type="HL",y.tbx0=Math.ceil(v.tcx0/C-.5),y.tby0=Math.ceil(v.tcy0/C),y.tbx1=Math.ceil(v.tcx1/C-.5),y.tby1=Math.ceil(v.tcy1/C),y.resolution=P,s(e,y,x),b.push(y),M.push(y),y={},y.type="LH",y.tbx0=Math.ceil(v.tcx0/C),y.tby0=Math.ceil(v.tcy0/C-.5),y.tbx1=Math.ceil(v.tcx1/C),y.tby1=Math.ceil(v.tcy1/C-.5),y.resolution=P,s(e,y,x),b.push(y),M.push(y),y={},y.type="HH",y.tbx0=Math.ceil(v.tcx0/C-.5),y.tby0=Math.ceil(v.tcy0/C-.5),y.tbx1=Math.ceil(v.tcx1/C-.5),y.tby1=Math.ceil(v.tcy1/C-.5),y.resolution=P,s(e,y,x),b.push(y),M.push(y),P.subbands=M}}v.resolutions=p,v.subbands=b}var S=i.codingStyleDefaultParameters.progressionOrder;switch(S){case 0:i.packetsIterator=new c(e);break;case 1:i.packetsIterator=new h(e);break;case 2:i.packetsIterator=new l(e);break;case 3:i.packetsIterator=new u(e);break;case 4:i.packetsIterator=new d(e);break;default:throw new Error("JPX Error: Unsupported progression order "+S)}}function p(e,t,r,i){var n,a=0,s=0,o=!1;function c(e){while(s<e){var i=t[r+a];a++,o?(n=n<<7|i,s+=7,o=!1):(n=n<<8|i,s+=8),255===i&&(o=!0)}return s-=e,n>>>s&(1<<e)-1}function h(e){return 255===t[r+a-1]&&t[r+a]===e?(l(1),!0):255===t[r+a]&&t[r+a+1]===e&&(l(2),!0)}function l(e){a+=e}function u(){s=0,o&&(a++,o=!1)}function d(){if(0===c(1))return 1;if(0===c(1))return 2;var e=c(2);return e<3?e+3:(e=c(5),e<31?e+6:(e=c(7),e+37))}var f=e.currentTile.index,v=e.tiles[f],m=e.COD.sopMarkerUsed,p=e.COD.ephMarkerUsed,b=v.packetsIterator;while(a<i){u(),m&&h(145)&&l(4);var g=b.nextPacket();if(void 0===g)return;if(c(1)){for(var y,x=g.layerNumber,C=[],M=0,S=g.codeblocks.length;M<S;M++){y=g.codeblocks[M];var k,z=y.precinct,T=y.cbx-z.cbxMin,U=y.cby-z.cbyMin,L=!1,I=!1;if(void 0!==y["included"])L=!!c(1);else{var O,X;if(z=y.precinct,void 0!==z["inclusionTree"])O=z.inclusionTree;else{var A=z.cbxMax-z.cbxMin+1,D=z.cbyMax-z.cbyMin+1;O=new w(A,D,x),X=new P(A,D),z.inclusionTree=O,z.zeroBitPlanesTree=X;for(var E=0;E<x;E++)if(0!==c(1))throw new Error("JPX Error: Invalid tag tree")}if(O.reset(T,U,x))while(1){if(!c(1)){O.incrementValue(x);break}if(k=!O.nextLevel(),k){y.included=!0,L=I=!0;break}}}if(L){if(I){X=z.zeroBitPlanesTree,X.reset(T,U);while(1)if(c(1)){if(k=!X.nextLevel(),k)break}else X.incrementValue();y.zeroBitPlanes=X.value}var H=d();while(c(1))y.Lblock++;var B=log2(H),_=(H<1<<B?B-1:B)+y.Lblock,Y=c(_);C.push({codeblock:y,codingpasses:H,dataLength:Y})}}u(),p&&h(146);while(C.length>0){var N=C.shift();y=N.codeblock,void 0===y["data"]&&(y.data=[]),y.data.push({data:t,start:r+a,end:r+a+N.dataLength,codingpasses:N.codingpasses}),a+=N.dataLength}}}return a}function b(e,t,r,i,n,a,s,o){for(var c=i.tbx0,h=i.tby0,l=i.tbx1-i.tbx0,u=i.codeblocks,d="H"===i.type.charAt(0)?1:0,f="H"===i.type.charAt(1)?t:0,v=0,m=u.length;v<m;++v){var p=u[v],b=p.tbx1_-p.tbx0_,g=p.tby1_-p.tby0_;if(0!==b&&0!==g&&void 0!==p["data"]){var y,x;y=new C(b,g,p.subbandType,p.zeroBitPlanes,a),x=2;var P,w,M,S=p.data,k=0,z=0;for(P=0,w=S.length;P<w;P++)M=S[P],k+=M.end-M.start,z+=M.codingpasses;var T=new Int16Array(k),U=0;for(P=0,w=S.length;P<w;P++){M=S[P];var L=M.data.subarray(M.start,M.end);T.set(L,U),U+=L.length}var I=new ArithmeticDecoder(T,0,k);for(y.setDecoder(I),P=0;P<z;P++){switch(x){case 0:y.runSignificancePropogationPass();break;case 1:y.runMagnitudeRefinementPass();break;case 2:y.runCleanupPass(),o&&y.checkSegmentationSymbol();break}x=(x+1)%3}var O,X,A,D=p.tbx0_-c+(p.tby0_-h)*l,E=y.coefficentsSign,H=y.coefficentsMagnitude,B=y.bitsDecoded,_=s?0:.5;U=0;var Y="LL"!==i.type;for(P=0;P<g;P++){var N=D/l|0,Q=2*N*(t-l)+d+f;for(O=0;O<b;O++){if(X=H[U],0!==X){X=(X+_)*n,0!==E[U]&&(X=-X),A=B[U];var Z=Y?Q+(D<<1):D;e[Z]=s&&A>=a?X:X*(1<<a-A)}D++,U++}D+=l-b}}}}function g(t,r,i){for(var n=r.components[i],a=n.codingStyleParameters,s=n.quantizationParameters,o=a.decompositionLevelsCount,c=s.SPqcds,h=s.scalarExpounded,l=s.guardBits,u=a.segmentationSymbolUsed,d=t.components[i].precision,f=a.reversibleTransformation,v=f?new k:new S,m=[],p=0,g=0;g<=o;g++){for(var y=n.resolutions[g],x=y.trx1-y.trx0,P=y.try1-y.try0,w=new Float32Array(x*P),C=0,M=y.subbands.length;C<M;C++){var z,T;h?(z=c[p].mu,T=c[p].epsilon,p++):(z=c[0].mu,T=c[0].epsilon+(g>0?1-g:0));var U=y.subbands[C],L=e[U.type],I=f?1:Math.pow(2,d+L-T)*(1+z/2048),O=l+T-1;b(w,x,P,U,I,O,f,u)}m.push({width:x,height:P,items:w})}var X=v.calculate(m,n.tcx0,n.tcy0);return{left:n.tcx0,top:n.tcy0,width:X.width,height:X.height,items:X.items}}function y(e){for(var t=e.SIZ,r=e.components,i=t.Csiz,n=[],a=0,s=e.tiles.length;a<s;a++){var o,c=e.tiles[a],h=[];for(o=0;o<i;o++)h[o]=g(e,c,o);var l,u,d,f,v,m,p,b,y,x,P,w,C,M,S,k=h[0],z=new Int16Array(k.items.length*i),T={left:k.left,top:k.top,width:k.width,height:k.height,items:z},U=0;if(c.codingStyleDefaultParameters.multipleComponentTransform){var L=4===i,I=h[0].items,O=h[1].items,X=h[2].items,A=L?h[3].items:null;l=r[0].precision-8,u=.5+(128<<l),d=255*(1<<l),v=.5*d,f=-v;var D=c.components[0],E=i-3;if(p=I.length,D.codingStyleParameters.reversibleTransformation)for(m=0;m<p;m++,U+=E)b=I[m]+u,y=O[m],x=X[m],w=b-(x+y>>2),P=w+x,C=w+y,z[U++]=P<=0?0:P>=d?255:P>>l,z[U++]=w<=0?0:w>=d?255:w>>l,z[U++]=C<=0?0:C>=d?255:C>>l;else for(m=0;m<p;m++,U+=E)b=I[m]+u,y=O[m],x=X[m],P=b+1.402*x,w=b-.34413*y-.71414*x,C=b+1.772*y,z[U++]=P<=0?0:P>=d?255:P>>l,z[U++]=w<=0?0:w>=d?255:w>>l,z[U++]=C<=0?0:C>=d?255:C>>l;if(L)for(m=0,U=3;m<p;m++,U+=4)M=A[m],z[U]=M<=f?0:M>=v?255:M+u>>l}else for(o=0;o<i;o++)if(8===r[o].precision){var H=h[o].items;for(l=r[o].precision-8,u=.5+(128<<l),d=127.5*(1<<l),f=-d,U=o,m=0,p=H.length;m<p;m++)S=H[m],z[U]=S<=f?0:S>=d?255:S+u>>l,U+=i}else{var B=r[o].isSigned;H=h[o].items;for(B?(l=0,u=0):(l=r[o].precision-8,u=.5+(128<<l)),U=o,m=0,p=H.length;m<p;m++)S=H[m],z[U]=S+u,U+=i}n.push(T)}return n}function x(e,t){for(var r=e.SIZ,i=r.Csiz,n=e.tiles[t],a=0;a<i;a++){var s=n.components[a],o=void 0!==e.currentTile.QCC[a]?e.currentTile.QCC[a]:e.currentTile.QCD;s.quantizationParameters=o;var c=void 0!==e.currentTile.COC[a]?e.currentTile.COC[a]:e.currentTile.COD;s.codingStyleParameters=c}n.codingStyleDefaultParameters=e.currentTile.COD}t.prototype={parse:function(e){var t=readUint16(e,0);if(65359!==t){var r=0,i=e.length;while(r<i){var n=8,a=readUint32(e,r),s=readUint32(e,r+4);if(r+=n,1===a&&(a=4294967296*readUint32(e,r)+readUint32(e,r+4),r+=8,n+=8),0===a&&(a=i-r+n),a<n)throw new Error("JPX Error: Invalid box field size");var o=a-n,c=!0;switch(s){case 1785737832:c=!1;break;case 1668246642:var h=e[r];e[r+1],e[r+2];if(1===h){var l=readUint32(e,r+3);switch(l){case 16:case 17:case 18:break;default:warn("Unknown colorspace "+l);break}}else 2===h&&info("ICC profile not supported");break;case 1785737827:this.parseCodestream(e,r,r+o);break;case 1783636e3:218793738!==readUint32(e,r)&&warn("Invalid JP2 signature");break;case 1783634458:case 1718909296:case 1920099697:case 1919251232:case 1768449138:break;default:var u=String.fromCharCode(s>>24&255,s>>16&255,s>>8&255,255&s);warn("Unsupported header type "+s+" ("+u+")");break}c&&(r+=o)}}else this.parseCodestream(e,0,e.length)},parseImageProperties:function(e){var t=e.getByte();while(t>=0){var r=t;t=e.getByte();var i=r<<8|t;if(65361===i){e.skip(4);var n=e.getInt32()>>>0,a=e.getInt32()>>>0,s=e.getInt32()>>>0,o=e.getInt32()>>>0;e.skip(16);var c=e.getUint16();return this.width=n-s,this.height=a-o,this.componentsCount=c,void(this.bitsPerComponent=8)}}throw new Error("JPX Error: No size marker found in JPX stream")},parseCodestream:function(e,t,n){var a={};try{var s=!1,o=t;while(o+1<n){var c=readUint16(e,o);o+=2;var h,l,u,d,f,v,b=0;switch(c){case 65359:a.mainHeader=!0;break;case 65497:break;case 65361:b=readUint16(e,o);var g={};g.Xsiz=readUint32(e,o+4),g.Ysiz=readUint32(e,o+8),g.XOsiz=readUint32(e,o+12),g.YOsiz=readUint32(e,o+16),g.XTsiz=readUint32(e,o+20),g.YTsiz=readUint32(e,o+24),g.XTOsiz=readUint32(e,o+28),g.YTOsiz=readUint32(e,o+32);var P=readUint16(e,o+36);g.Csiz=P;var w=[];h=o+38;for(var C=0;C<P;C++){var M={precision:1+(127&e[h]),isSigned:!!(128&e[h]),XRsiz:e[h+1],YRsiz:e[h+1]};r(M,g),w.push(M)}a.SIZ=g,a.components=w,i(a,w),a.QCC=[],a.COC=[];break;case 65372:b=readUint16(e,o);var S={};switch(h=o+2,l=e[h++],31&l){case 0:d=8,f=!0;break;case 1:d=16,f=!1;break;case 2:d=16,f=!0;break;default:throw new Error("JPX Error: Invalid SQcd value "+l)}S.noQuantization=8===d,S.scalarExpounded=f,S.guardBits=l>>5,u=[];while(h<b+o){var k={};8===d?(k.epsilon=e[h++]>>3,k.mu=0):(k.epsilon=e[h]>>3,k.mu=(7&e[h])<<8|e[h+1],h+=2),u.push(k)}S.SPqcds=u,a.mainHeader?a.QCD=S:(a.currentTile.QCD=S,a.currentTile.QCC=[]);break;case 65373:b=readUint16(e,o);var z,T={};switch(h=o+2,a.SIZ.Csiz<257?z=e[h++]:(z=readUint16(e,h),h+=2),l=e[h++],31&l){case 0:d=8,f=!0;break;case 1:d=16,f=!1;break;case 2:d=16,f=!0;break;default:throw new Error("JPX Error: Invalid SQcd value "+l)}T.noQuantization=8===d,T.scalarExpounded=f,T.guardBits=l>>5,u=[];while(h<b+o)k={},8===d?(k.epsilon=e[h++]>>3,k.mu=0):(k.epsilon=e[h]>>3,k.mu=(7&e[h])<<8|e[h+1],h+=2),u.push(k);T.SPqcds=u,a.mainHeader?a.QCC[z]=T:a.currentTile.QCC[z]=T;break;case 65362:b=readUint16(e,o);var U={};h=o+2;var L=e[h++];U.entropyCoderWithCustomPrecincts=!!(1&L),U.sopMarkerUsed=!!(2&L),U.ephMarkerUsed=!!(4&L),U.progressionOrder=e[h++],U.layersCount=readUint16(e,h),h+=2,U.multipleComponentTransform=e[h++],U.decompositionLevelsCount=e[h++],U.xcb=2+(15&e[h++]),U.ycb=2+(15&e[h++]);var I=e[h++];if(U.selectiveArithmeticCodingBypass=!!(1&I),U.resetContextProbabilities=!!(2&I),U.terminationOnEachCodingPass=!!(4&I),U.verticalyStripe=!!(8&I),U.predictableTermination=!!(16&I),U.segmentationSymbolUsed=!!(32&I),U.reversibleTransformation=e[h++],U.entropyCoderWithCustomPrecincts){var O=[];while(h<b+o){var X=e[h++];O.push({PPx:15&X,PPy:X>>4})}U.precinctsSizes=O}var A=[];if(U.selectiveArithmeticCodingBypass&&A.push("selectiveArithmeticCodingBypass"),U.resetContextProbabilities&&A.push("resetContextProbabilities"),U.terminationOnEachCodingPass&&A.push("terminationOnEachCodingPass"),U.verticalyStripe&&A.push("verticalyStripe"),U.predictableTermination&&A.push("predictableTermination"),A.length>0)throw s=!0,new Error("JPX Error: Unsupported COD options ("+A.join(", ")+")");a.mainHeader?a.COD=U:(a.currentTile.COD=U,a.currentTile.COC=[]);break;case 65424:b=readUint16(e,o),v={},v.index=readUint16(e,o+2),v.length=readUint32(e,o+4),v.dataEnd=v.length+o-2,v.partIndex=e[o+8],v.partsCount=e[o+9],a.mainHeader=!1,0===v.partIndex&&(v.COD=a.COD,v.COC=a.COC.slice(0),v.QCD=a.QCD,v.QCC=a.QCC.slice(0)),a.currentTile=v;break;case 65427:v=a.currentTile,0===v.partIndex&&(x(a,v.index),m(a)),b=v.dataEnd-o,p(a,e,o,b);break;case 65365:case 65367:case 65368:case 65380:case 65363:b=readUint16(e,o);break;default:throw new Error("JPX Error: Unknown codestream code: "+c.toString(16))}o+=b}}catch(D){if(s||this.failOnCorruptedImage)throw D;warn("Trying to recover from "+D.message)}this.tiles=y(a),this.width=a.SIZ.Xsiz-a.SIZ.XOsiz,this.height=a.SIZ.Ysiz-a.SIZ.YOsiz,this.componentsCount=a.SIZ.Csiz}};var P=function(){function e(e,t){var r=log2(Math.max(e,t))+1;this.levels=[];for(var i=0;i<r;i++){var n={width:e,height:t,items:[]};this.levels.push(n),e=Math.ceil(e/2),t=Math.ceil(t/2)}}return e.prototype={reset:function(e,t){var r,i=0,n=0;while(i<this.levels.length){r=this.levels[i];var a=e+t*r.width;if(void 0!==r.items[a]){n=r.items[a];break}r.index=a,e>>=1,t>>=1,i++}i--,r=this.levels[i],r.items[r.index]=n,this.currentLevel=i,delete this.value},incrementValue:function(){var e=this.levels[this.currentLevel];e.items[e.index]++},nextLevel:function(){var e=this.currentLevel,t=this.levels[e],r=t.items[t.index];return e--,e<0?(this.value=r,!1):(this.currentLevel=e,t=this.levels[e],t.items[t.index]=r,!0)}},e}(),w=function(){function e(e,t,r){var i=log2(Math.max(e,t))+1;this.levels=[];for(var n=0;n<i;n++){for(var a=new Int16Array(e*t),s=0,o=a.length;s<o;s++)a[s]=r;var c={width:e,height:t,items:a};this.levels.push(c),e=Math.ceil(e/2),t=Math.ceil(t/2)}}return e.prototype={reset:function(e,t,r){var i=0;while(i<this.levels.length){var n=this.levels[i],a=e+t*n.width;n.index=a;var s=n.items[a];if(255===s)break;if(s>r)return this.currentLevel=i,this.propagateValues(),!1;e>>=1,t>>=1,i++}return this.currentLevel=i-1,!0},incrementValue:function(e){var t=this.levels[this.currentLevel];t.items[t.index]=e+1,this.propagateValues()},propagateValues:function(){var e=this.currentLevel,t=this.levels[e],r=t.items[t.index];while(--e>=0)t=this.levels[e],t.items[t.index]=r},nextLevel:function(){var e=this.currentLevel,t=this.levels[e],r=t.items[t.index];return t.items[t.index]=255,e--,!(e<0)&&(this.currentLevel=e,t=this.levels[e],t.items[t.index]=r,!0)}},e}(),C=function(){var e=17,t=18,r=new Uint8Array([0,5,8,0,3,7,8,0,4,7,8,0,0,0,0,0,1,6,8,0,3,7,8,0,4,7,8,0,0,0,0,0,2,6,8,0,3,7,8,0,4,7,8,0,0,0,0,0,2,6,8,0,3,7,8,0,4,7,8,0,0,0,0,0,2,6,8,0,3,7,8,0,4,7,8]),i=new Uint8Array([0,3,4,0,5,7,7,0,8,8,8,0,0,0,0,0,1,3,4,0,6,7,7,0,8,8,8,0,0,0,0,0,2,3,4,0,6,7,7,0,8,8,8,0,0,0,0,0,2,3,4,0,6,7,7,0,8,8,8,0,0,0,0,0,2,3,4,0,6,7,7,0,8,8,8]),n=new Uint8Array([0,1,2,0,1,2,2,0,2,2,2,0,0,0,0,0,3,4,5,0,4,5,5,0,5,5,5,0,0,0,0,0,6,7,7,0,7,7,7,0,7,7,7,0,0,0,0,0,8,8,8,0,8,8,8,0,8,8,8,0,0,0,0,0,8,8,8,0,8,8,8,0,8,8,8]);function a(e,t,a,s,o){this.width=e,this.height=t,this.contextLabelTable="HH"===a?n:"HL"===a?i:r;var c=e*t;this.neighborsSignificance=new Uint8Array(c),this.coefficentsSign=new Uint8Array(c),this.coefficentsMagnitude=o>14?new Uint32Array(c):o>6?new Uint16Array(c):new Uint8Array(c),this.processingFlags=new Uint8Array(c);var h=new Uint8Array(c);if(0!==s)for(var l=0;l<c;l++)h[l]=s;this.bitsDecoded=h,this.reset()}return a.prototype={setDecoder:function(e){this.decoder=e},reset:function(){this.contexts=new Int8Array(19),this.contexts[0]=8,this.contexts[e]=92,this.contexts[t]=6},setNeighborsSignificance:function(e,t,r){var i,n=this.neighborsSignificance,a=this.width,s=this.height,o=t>0,c=t+1<a;e>0&&(i=r-a,o&&(n[i-1]+=16),c&&(n[i+1]+=16),n[i]+=4),e+1<s&&(i=r+a,o&&(n[i-1]+=16),c&&(n[i+1]+=16),n[i]+=4),o&&(n[r-1]+=1),c&&(n[r+1]+=1),n[r]|=128},runSignificancePropogationPass:function(){for(var e=this.decoder,t=this.width,r=this.height,i=this.coefficentsMagnitude,n=this.coefficentsSign,a=this.neighborsSignificance,s=this.processingFlags,o=this.contexts,c=this.contextLabelTable,h=this.bitsDecoded,l=-2,u=1,d=2,f=0;f<r;f+=4)for(var v=0;v<t;v++)for(var m=f*t+v,p=0;p<4;p++,m+=t){var b=f+p;if(b>=r)break;if(s[m]&=l,!i[m]&&a[m]){var g=c[a[m]],y=e.readBit(o,g);if(y){var x=this.decodeSignBit(b,v,m);n[m]=x,i[m]=1,this.setNeighborsSignificance(b,v,m),s[m]|=d}h[m]++,s[m]|=u}}},decodeSignBit:function(e,t,r){var i,n,a,s,o,c,h=this.width,l=this.height,u=this.coefficentsMagnitude,d=this.coefficentsSign;s=t>0&&0!==u[r-1],t+1<h&&0!==u[r+1]?(a=d[r+1],s?(n=d[r-1],i=1-a-n):i=1-a-a):s?(n=d[r-1],i=1-n-n):i=0;var f=3*i;return s=e>0&&0!==u[r-h],e+1<l&&0!==u[r+h]?(a=d[r+h],s?(n=d[r-h],i=1-a-n+f):i=1-a-a+f):s?(n=d[r-h],i=1-n-n+f):i=f,i>=0?(o=9+i,c=this.decoder.readBit(this.contexts,o)):(o=9-i,c=1^this.decoder.readBit(this.contexts,o)),c},runMagnitudeRefinementPass:function(){for(var e,t=this.decoder,r=this.width,i=this.height,n=this.coefficentsMagnitude,a=this.neighborsSignificance,s=this.contexts,o=this.bitsDecoded,c=this.processingFlags,h=1,l=2,u=r*i,d=4*r,f=0;f<u;f=e){e=Math.min(u,f+d);for(var v=0;v<r;v++)for(var m=f+v;m<e;m+=r)if(n[m]&&0===(c[m]&h)){var p=16;if(0!==(c[m]&l)){c[m]^=l;var b=127&a[m];p=0===b?15:14}var g=t.readBit(s,p);n[m]=n[m]<<1|g,o[m]++,c[m]|=h}}},runCleanupPass:function(){for(var r,i=this.decoder,n=this.width,a=this.height,s=this.neighborsSignificance,o=this.coefficentsMagnitude,c=this.coefficentsSign,h=this.contexts,l=this.contextLabelTable,u=this.bitsDecoded,d=this.processingFlags,f=1,v=2,m=n,p=2*n,b=3*n,g=0;g<a;g=r){r=Math.min(g+4,a);for(var y=g*n,x=g+3<a,P=0;P<n;P++){var w,C=y+P,M=x&&0===d[C]&&0===d[C+m]&&0===d[C+p]&&0===d[C+b]&&0===s[C]&&0===s[C+m]&&0===s[C+p]&&0===s[C+b],S=0,k=C,z=g;if(M){var T=i.readBit(h,t);if(!T){u[C]++,u[C+m]++,u[C+p]++,u[C+b]++;continue}S=i.readBit(h,e)<<1|i.readBit(h,e),0!==S&&(z=g+S,k+=S*n),w=this.decodeSignBit(z,P,k),c[k]=w,o[k]=1,this.setNeighborsSignificance(z,P,k),d[k]|=v,k=C;for(var U=g;U<=z;U++,k+=n)u[k]++;S++}for(z=g+S;z<r;z++,k+=n)if(!o[k]&&0===(d[k]&f)){var L=l[s[k]],I=i.readBit(h,L);1===I&&(w=this.decodeSignBit(z,P,k),c[k]=w,o[k]=1,this.setNeighborsSignificance(z,P,k),d[k]|=v),u[k]++}}}},checkSegmentationSymbol:function(){var t=this.decoder,r=this.contexts,i=t.readBit(r,e)<<3|t.readBit(r,e)<<2|t.readBit(r,e)<<1|t.readBit(r,e);if(10!==i)throw new Error("JPX Error: Invalid segmentation symbol")}},a}(),M=function(){function e(){}return e.prototype.calculate=function(e,t,r){for(var i=e[0],n=1,a=e.length;n<a;n++)i=this.iterate(i,e[n],t,r);return i},e.prototype.extend=function(e,t,r){var i=t-1,n=t+1,a=t+r-2,s=t+r;e[i--]=e[n++],e[s++]=e[a--],e[i--]=e[n++],e[s++]=e[a--],e[i--]=e[n++],e[s++]=e[a--],e[i]=e[n],e[s]=e[a]},e.prototype.iterate=function(e,t,r,i){var n,a,s,o,c,h,l=e.width,u=e.height,d=e.items,f=t.width,v=t.height,m=t.items;for(s=0,n=0;n<u;n++)for(o=2*n*f,a=0;a<l;a++,s++,o+=2)m[o]=d[s];d=e.items=null;var p=4,b=new Float32Array(f+2*p);if(1===f){if(0!==(1&r))for(h=0,s=0;h<v;h++,s+=f)m[s]*=.5}else for(h=0,s=0;h<v;h++,s+=f)b.set(m.subarray(s,s+f),p),this.extend(b,p,f),this.filter(b,p,f),m.set(b.subarray(p,p+f),s);var g=16,y=[];for(n=0;n<g;n++)y.push(new Float32Array(v+2*p));var x,P=0;if(e=p+v,1===v){if(0!==(1&i))for(c=0;c<f;c++)m[c]*=.5}else for(c=0;c<f;c++){if(0===P){for(g=Math.min(f-c,g),s=c,o=p;o<e;s+=f,o++)for(x=0;x<g;x++)y[x][o]=m[s+x];P=g}P--;var w=y[P];if(this.extend(w,p,v),this.filter(w,p,v),0===P)for(s=c-g+1,o=p;o<e;s+=f,o++)for(x=0;x<g;x++)m[s+x]=y[x][o]}return{width:f,height:v,items:m}},e}(),S=function(){function e(){M.call(this)}return e.prototype=Object.create(M.prototype),e.prototype.filter=function(e,t,r){var i,n,a,s,o=r>>1;t|=0;var c=-1.586134342059924,h=-.052980118572961,l=.882911075530934,u=.443506852043971,d=1.230174104914001,f=1/d;for(i=t-3,n=o+4;n--;i+=2)e[i]*=f;for(i=t-2,a=u*e[i-1],n=o+3;n--;i+=2){if(s=u*e[i+1],e[i]=d*e[i]-a-s,!n--)break;i+=2,a=u*e[i+1],e[i]=d*e[i]-a-s}for(i=t-1,a=l*e[i-1],n=o+2;n--;i+=2){if(s=l*e[i+1],e[i]-=a+s,!n--)break;i+=2,a=l*e[i+1],e[i]-=a+s}for(i=t,a=h*e[i-1],n=o+1;n--;i+=2){if(s=h*e[i+1],e[i]-=a+s,!n--)break;i+=2,a=h*e[i+1],e[i]-=a+s}if(0!==o)for(i=t+1,a=c*e[i-1],n=o;n--;i+=2){if(s=c*e[i+1],e[i]-=a+s,!n--)break;i+=2,a=c*e[i+1],e[i]-=a+s}},e}(),k=function(){function e(){M.call(this)}return e.prototype=Object.create(M.prototype),e.prototype.filter=function(e,t,r){var i,n,a=r>>1;for(t|=0,i=t,n=a+1;n--;i+=2)e[i]-=e[i-1]+e[i+1]+2>>2;for(i=t+1,n=a;n--;i+=2)e[i]+=e[i-1]+e[i+1]>>1},e}();return t}();